# Limpar as regras existentes
sudo iptables -F
sudo iptables -X

# Definir política padrão para DROP (bloquear todo o tráfego que não seja explicitamente permitido)
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

# Permitir todo o tráfego entre a rede local e a DMZ
sudo iptables -A FORWARD -i SubredeLocal -o RedePan -j ACCEPT
sudo iptables -A FORWARD -i RedePan -o SubredeLocal -j ACCEPT

# Bloquear qualquer acesso direto da Internet para a estação de trabalho
sudo iptables -A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT  # Permitir SSH para administração
sudo iptables -A INPUT -i eth0 -j DROP

# Permitir conexões de saída da estação de trabalho para a Internet para HTTP, HTTPS
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 80 -j ACCEPT
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 443 -j ACCEPT

# Permitir tráfego de saída para serviços de e-mail
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 25 -j ACCEPT  # SMTP
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 465 -j ACCEPT # SMTPS
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 587 -j ACCEPT # Submission
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 143 -j ACCEPT # IMAP
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 993 -j ACCEPT # IMAPS
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 110 -j ACCEPT # POP3
sudo iptables -A OUTPUT -o eth0 -p tcp --dport 995 -j ACCEPT # POP3S

# Restringir o acesso ao banco de dados
sudo iptables -A INPUT -i SubredeLocal -p tcp --dport 5432 -s IP_do_Servidor_de_Aplicacoes -j ACCEPT
sudo iptables -A INPUT -i eth0 -p tcp --dport 5432 -j DROP

# Restringir o acesso às portas 80 e 443 da SubredeLocal
sudo iptables -A INPUT -i SubredeLocal -p tcp --dport 80 -j DROP
sudo iptables -A INPUT -i SubredeLocal -p tcp --dport 443 -j DROP

# Restringir o acesso ao Servidor de Aplicações à SubredeLocal
sudo iptables -A INPUT -i eth0 -p tcp --dport 5432 -s IP_da_SubredeLocal -j ACCEPT
sudo iptables -A INPUT -i eth0 -p tcp --dport 5432 -j DROP

# Configurar encaminhamento de pacotes entre as interfaces de rede
echo 1 > /proc/sys/net/ipv4/ip_forward

sudo touch /etc/iptables/load_caiman_rules.sh

# Salvar as regras
sudo iptables-save > /etc/iptables/load_caiman_rules.sh

# Iniciar o serviço
exec "$@"